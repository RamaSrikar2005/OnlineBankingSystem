<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- ðŸ”’ HARD PROTECTION -->
    <script>
        if (!localStorage.getItem("user_id")) {
            window.location.replace("/login");
        }
    </script>
</head>

<body class="dashboard-bg">

<div class="dashboard-layout">

    <!-- ================= MAIN DASHBOARD ================= -->
    <div class="dashboard-box">

        <h2>Welcome <span id="username"></span></h2>

        <!-- BALANCE ROW -->
        <div class="balance-row">Balance</div>

        <button onclick="goTo('/account')">Create Account</button>
        <button onclick="goTo('/deposit')">Deposit Money</button>
        <button onclick="goTo('/fund-transfer')">Fund Transfer</button>
        <button onclick="goTo('/transactions')">Transaction History</button>
        <button onclick="goTo('/deactivate')">Deactivate Account</button>

        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- ================= BALANCE SIDE COLUMN ================= -->
    <div class="balance-side-box">
        <h3>Balances</h3>
        <div id="accounts">Loading...</div>
    </div>

</div>

<script>
/* ========================
   SHOW USER NAME (FIX)
======================== */
const fullName = localStorage.getItem("full_name");
document.getElementById("username").innerText = fullName ? fullName : "User";

/* ========================
   NAVIGATION
======================== */
function goTo(path) {
    window.location.href = path;
}

function logout() {
    localStorage.clear();
    window.location.replace("/login");
}

/* ========================
   LOAD ACCOUNTS (CRITICAL FIX)
======================== */
fetch("/api/accounts", {
    method: "GET",
    credentials: "same-origin"   // ðŸ”¥ REQUIRED FOR SESSION
})
.then(res => res.json())
.then(data => {
    const container = document.getElementById("accounts");
    container.innerHTML = "";

    if (data.error) {
        container.innerHTML = "<p>Server error</p>";
        return;
    }

    if (!data.accounts || data.accounts.length === 0) {
        container.innerHTML = "<p>No accounts found</p>";
        return;
    }

    data.accounts.forEach(acc => {
        const statusColor = acc.status === "ACTIVE" ? "green" : "red";

        container.innerHTML += `
            <div class="account-box">
                <strong>${acc.account_type}</strong><br>
                Account ID: ${acc.account_id}<br>
                Balance: â‚¹${acc.balance}<br>
                <span style="
                    display:inline-block;
                    margin-top:6px;
                    padding:4px 8px;
                    border-radius:6px;
                    font-size:12px;
                    color:white;
                    background:${statusColor};
                ">
                    ${acc.status}
                </span>
            </div>
        `;
    });
})
.catch(() => {
    document.getElementById("accounts").innerHTML =
        "<p>Server error</p>";
});
</script>

</body>
</html>
